---
layout: post
title: expect 自动化脚本
date: 2018-10-26
categories: expect
tags: [expect,linux]
description: 边学边记录。
---

![图片]({{ site.baseurl }}/img/post/expect-release.png)

### 实际使用场景
- mac 环境拉取svn 代码
- 本地Maven 生成war 文件
- 上传War 文件到服务器
- 切换ngx upstream
- 备份旧版本源代码，重启Tomcat
`expect release.sh`

`mac 本地expect 文件(release.sh)`
{% highlight Perl %}
#!/usr/bin/expect -f

puts "Input a number"
puts "1.1: 打包 war 文件"
puts "2.1: 上传 war (ALI_2)"
puts "2.2: ngx 关闭 (ALI_2) / 开启 (ALI_3)"
puts "2.3: 重启 tomcat (ALI_2)"
puts "3.1: 上传 war (ALI_3)"
puts "3.2: ngx 关闭 (ALI_3) / 开启 (ALI_2)"
puts "3.3: 重启 tomcat (ALI_3)"
puts "------------------------------"

set num [lindex $argv 0]
# S1 HOST
set s1host "0.0.0.1"
set s1psd "0001"

# S2 HOST
set s2host "0.0.0.2"
set s2psd "0002"

# S3 HOST
set s3host "0.0.0.3"
set s3psd "0003"

# Maven 生成war 文件,expect 调用shell
proc build_war {} {
	puts "Building.."

	cd /Users/Documents/xx-maven

	spawn sh ./mvn.sh

	interact
}

# 上传 war文件
proc upload {host psd} {
	puts "Uploading.."

	spawn scp -r /Users/Documents/xx-restful/target/xx-restful-0.0.1.war root@$host:/usr/restful
	
	expect "*password:"

	send "$psd\r"

	interact
}

# 调用服务器shell文件,重启tomcat服务
proc restart {host psd} {
	puts "Restarting.."

	spawn ssh root@$host "cd /usr/restful; sh release.sh"

	expect "*password:"

	send "$psd\r"

	interact
}

# 切换ngx 代理服务器
proc ngx_down_s2 {host psd} {
	puts "Reloading.."

	spawn ssh root@$host "cd /usr/local/nginx; sh api_down_s2_up_s3.sh"

	expect "*password:"

	send "$psd\r"

	interact
}

# 切换ngx 代理服务器
proc ngx_down_s3 {host psd} {
	puts "Reloading.."

	spawn ssh root@$host "cd /usr/local/nginx; sh api_down_s3_up_s2.sh"

	expect "*password:"

	send "$psd\r"

	interact
}

puts $num

switch -- $num {
	1.1 {
		build_war
	}
    2.1 {
       upload $s2host $s2psd
    }
    2.2 {
    	ngx_down_s2 $s1host $s1psd
    }
    2.3 {
       restart $s2host $s2psd
    }
    3.1 {
       upload $s3host $s3psd
    }
    3.2 {
    	ngx_down_s3 $s1host $s1psd
    }
    3.3 {
       restart $s3host $s3psd
    }
}
{% endhighlight %}

`mac 本地maven脚本 文件(mvn.sh)`
{% highlight Perl %}
mvn clean install
{% endhighlight %}

`服务器 重启tomcat,备份旧版本 文件(release.sh)`
{% highlight Perl %}
#!/bin/bash

_TOMCAT_PID=$( ps aux | grep tomcat | grep -v grep | awk '{print $2}' )

echo "======== 1. <kill tomcat> shutting down the tomcat  =========="
echo "Get Tomcat PID: " $_TOMCAT_PID

sh /usr/restful/tomcat/bin/shutdown.sh

if [[ ${_TOMCAT_PID} ]]   # if PID exists 
then
  echo "PID exists"
  echo "Kill ing... "
  kill -9 ${_TOMCAT_PID}
  sleep 3
else 
  echo "PID is not exists, ready for start."
fi

sleep 1

echo "======== 2. <backup webdir> move webdir file to History/  =========="

mv /usr/restful/webdir /usr/restful/bak/webdir.$(date +%Y%m%d%H%M)

echo "======== 3. <deploy new-war> unzip *.war to /webdir  =========="

unzip /usr/restful/xx-restful-0.0.1.war -d /usr/restful/webdir

echo "======== 4. <starting tomcat> startup.sh  =========="

sh /usr/restful/tomcat/bin/startup.sh

echo -e "\n\nBuild Complete."
echo "  ^_^  "
echo ""

tail -f /usr/restful/logs/info.log
{% endhighlight %}

`切换ngx 代理服务器脚本(api_down_s3_up_s2.sh)`
{% highlight Perl %}
#! /bin/sh

cp /usr/local/nginx/conf/conf.d/ma_443.conf /usr/local/nginx/conf/conf.d/bak/ma_443.conf.$(date +%Y%m%d%H%M)

sed -i '5c server 0.0.0.2:8080;' /usr/local/nginx/conf/conf.d/ma_443.conf
sed -i '6c server 0.0.0.3:8080 down;' /usr/local/nginx/conf/conf.d/ma_443.conf

/usr/local/nginx/sbin/nginx -t
/usr/local/nginx/sbin/nginx -s reload
{% endhighlight %}


`ma_443.conf`
{% highlight Perl %}
# S2 0.0.0.2
# S3 0.0.0.3

upstream apiServer {    
server 0.0.0.2:8080;
server 0.0.0.3:8080 down;
}  

server {
    listen 443;
    server_name host.com;
    
    ...
}
{% endhighlight %}